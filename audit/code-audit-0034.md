# audit/code-audit-0034

**Дата:** 2025-10-12  
**Задача:** Реализация вкладки "Лига" в публичном фронтенде с поддержкой активного сезона и таблицы  
**Исполнитель:** GitHub Copilot

## 1. Поисковые запросы
- "selectedSeason"
- "league table"
- "fetchSeasons"
- "leaderboard"

## 2. Просканированные пути
- frontend/src
- admin/src/store
- backend/src/routes
- prisma/schema.prisma
- docs/

## 3. Найденные артефакты
- `admin/src/store/adminStore.ts` — логика выбора сезона и загрузки данных для админки.
- `docs/cache.md` — политика кэширования публичных агрегатов (ключи `public:league:*`).
- `docs/state.md` — целевой контракт единого стора и список вкладок публичного приложения.
- `frontend/src/App.tsx` — текущее дерево вкладок публичного SPA.
- `prisma/schema.prisma` — модель `Season` без признака активного сезона.

## 4. Решение
Реализация нового публичного модуля лиги с полноценным API и стором. Добавим поле активности сезона в БД и админ-панель, публичный REST endpoint и WebSocket топик `public:league:table`. На фронте создадим страницы и компоненты с табами, адаптируем глобальную навигацию (двойной тап по "Лига" → раскрывающийся сайдбар и скрытие bottom-nav), интегрируем единый стор с подпиской на WS и кэш по TTL, реализуем таблицу standings. Обеспечим кэширование (multi-level + Redis), версионирование ответов и синхронизацию с админ кнопкой "Сделать активным".

## 5. План реализации
- [ ] Расширить Prisma модель `Season` полем `isActive`, миграция, генерация клиента.
- [ ] Реализовать backend endpoints: PATCH админки для установки активного сезона, публичный GET `/api/league/table` и публикация WS топика.
- [ ] Обновить admin UI: кнопка сохранения активного сезона, синхронизация стора, TTL инвалидация, уведомления.
- [ ] Реализовать shared типы и стор публичного фронта для League (HTTP + WS, cache/ETag).
- [ ] Рефактор frontend структуры (`pages/`, `components/league/*`), обновить App навигацию, реализовать вкладку "Таблица".
- [ ] Создать заглушки для прочих подвкладок (статистика, расписание, результаты) с будущими интеграциями.
- [ ] Обновить документацию (`docs/state.md`, `docs/project.md`, `docs/cache.md`, `roadmap` при необходимости).
- [ ] Прогнать lint/build для backend и frontend, собрать билды и поднять dev сервер фронта.
- [ ] Тестирование WebSocket публикации/подписок (при недоступности Redis — fallback polling).

## 6. Метрическое влияние
⚪ — Улучшение: активный сезон и live-таблица повышают вовлечённость пользователей и прозрачность данных без ухудшения стабильности.
