# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Profile –∏ WebSocket –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã User ‚Üí AppUser #0007

**–î–∞—Ç–∞:** 02 Oct 2025  
**–¢–∏–ø:** Bug Fix  
**–í–ª–∏—è–Ω–∏–µ:** üî¥ User Experience  

## –î–û
- Profile.tsx –ø–æ–∫–∞–∑—ã–≤–∞–ª "–ì–æ—Å—Ç—å" –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–ª—Å—è (–æ—à–∏–±–∫–∞ "no websocket handler")
- Frontend –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É User (userId, tgUsername)
- Backend –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É AppUser (telegramId, username, firstName)
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π –º–µ–∂–¥—É frontend –∏ backend

## –ü–û–°–õ–ï
- Profile.tsx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º
- Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É AppUser
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—è –º–µ–∂–¥—É frontend –∏ backend
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `frontend/src/Profile.tsx`

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- `user?.userId` ‚Üí `user?.telegramId`
- `user?.tgUsername` ‚Üí `user?.username || user?.firstName`
- `payload.userId` ‚Üí `payload.telegramId`

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω fallback –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```typescript
// –î–û:
setUser({
  tgUsername: fallbackName || '–ì–æ—Å—Ç—å',
  photoUrl: unsafe.photo_url,
  createdAt: new Date().toISOString()
})

// –ü–û–°–õ–ï:
setUser({
  telegramId: unsafe.id,
  username: unsafe.username,
  firstName: unsafe.first_name,
  createdAt: new Date().toISOString()
})
```

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã WebSocket topics:
```typescript
// –î–û:
const userTopic = `user:${user.userId}`

// –ü–û–°–õ–ï: 
const userTopic = `user:${user.telegramId}`
```

### 2. `backend/src/realtime/index.ts`

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è WebSocket —Ä–æ—É—Ç–∞:
```typescript
// –î–û:
server.get('/realtime', (connection: any, req: any) => {

// –ü–û–°–õ–ï:
server.get('/realtime', { websocket: true }, (connection: any, req: any) => {
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

–ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã User ‚Üí AppUser –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:

**–°—Ç–∞—Ä–∞—è –º–æ–¥–µ–ª—å User:**
- `userId: BigInt` 
- `tgUsername: string`
- `photoUrl: string`

**–ù–æ–≤–∞—è –º–æ–¥–µ–ª—å AppUser:**
- `telegramId: BigInt`
- `username: string | null`
- `firstName: string | null`

Frontend –ø—Ä–æ–¥–æ–ª–∂–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
1. `user?.userId` ‚Üí `undefined` ‚Üí –ø–æ–∫–∞–∑ "–ì–æ—Å—Ç—å"
2. WebSocket topics –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏ –∏–∑-–∑–∞ `undefined` –≤ `user:${undefined}`
3. WebSocket —Ä–æ—É—Ç –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–µ—Ç—Ä–∏–∫–∏
- **Retention:** üî¥ - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- **Engagement:** üî¥ - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: —Ä–∞–±–æ—Ç–∞—é—Ç real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **Revenue:** ‚ö™ - –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
- **Tech Stability:** üî¥ - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥–∏

## –ü—Ä–æ–≤–µ—Ä–∫–∏
```bash
cd frontend && npm run build    # ‚úÖ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
cd backend && npm run build     # ‚úÖ –±–µ–∫–µ–Ω–¥ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
# –¢–µ—Å—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ: –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–º—è –≤–º–µ—Å—Ç–æ "–ì–æ—Å—Ç—å" ‚úÖ
# –¢–µ—Å—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ: WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ ‚úÖ
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
‚úÖ –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å:
- –°—Ö–µ–º–æ–π AppUser –∏–∑ BD.md
- Backend API endpoints (/api/auth/me)
- JWT —Ç–æ–∫–µ–Ω–∞–º–∏ —Å telegramId –≤ sub
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ WebSocket

## –†–∏—Å–∫–∏ –∏ mitigation
- **–†–∏—Å–∫:** –ö—ç—à –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ User
- **Mitigation:** –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–π localStorage –æ—á–∏—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- **–†–∏—Å–∫:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ JWT —Ç–æ–∫–µ–Ω—ã –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è  
- **Mitigation:** –¢–æ–∫–µ–Ω—ã –∏–º–µ—é—Ç TTL 7 –¥–Ω–µ–π, –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
1. ‚úÖ Profile —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. ‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è  
3. üü® –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –¥–µ–π—Å—Ç–≤–∏–∏
4. üü® –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª–µ–π User