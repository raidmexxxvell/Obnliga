# Audit: Real-time Profile Updates —á–µ—Ä–µ–∑ WebSocket (0012-realtime-profile)

**–î–∞—Ç–∞:** 1 –æ–∫—Ç—è–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä:** GitHub Copilot  
**–¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è:** Feature - Real-time Profile Broadcasting

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ WebSocket, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–ø–∏–∫–∏

### 1. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–¢–æ–ø–∏–∫:** `user:${userId}` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `user:515650034`)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ü–æ–¥–ø–∏—Å—á–∏–∫–∏:** –°–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å–≤–æ–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è

### 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π  
- **–¢–æ–ø–∏–∫:** `profile`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –¥–ª—è –∞–¥–º–∏–Ω–∫–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- **–ü–æ–¥–ø–∏—Å—á–∏–∫–∏:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø–∞–Ω–µ–ª–∏, –¥–∞—à–±–æ—Ä–¥—ã

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Backend

### 1. –ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ routes/authRoutes.ts
```typescript
// –ü–æ—Å–ª–µ upsert –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await (server as any).publishTopic(`user:${userId}`, {
  type: 'profile_updated',
  userId: userPayload.userId,
  tgUsername: userPayload.tgUsername,
  photoUrl: userPayload.photoUrl,
  updatedAt: userPayload.updatedAt
})

await (server as any).publishTopic('profile', {
  type: 'profile_updated',
  userId: userPayload.userId,
  // ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
})
```

### 2. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ routes/userRoutes.ts
**–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
- `PUT /api/users/:userId` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
- `PUT /api/users/batch` ‚Äî –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–¥–º–∏–Ω–∫–∏

**–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å:**
- –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –∫—ç—à: `defaultCache.invalidate(userCacheKey)`
- –ü—É–±–ª–∏–∫—É—é—Ç WebSocket –ø–∞—Ç—á–∏ –≤ –æ–±–∞ —Ç–æ–ø–∏–∫–∞
- –õ–æ–≥–∏—Ä—É—é—Ç —É—Å–ø–µ—à–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Frontend

### 1. Profile.tsx - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ WebSocket
```typescript
useEffect(() => {
  if (!user?.userId) return

  const userTopic = `user:${user.userId}`
  const profileTopic = 'profile'
  
  wsClient.subscribe(userTopic)
  wsClient.subscribe(profileTopic)

  const handlePatch = (msg: any) => {
    if (msg.type === 'patch') {
      const { topic, payload } = msg
      
      if (topic === userTopic && payload.userId === user.userId) {
        setUser(prev => ({ ...prev, ...payload }))
        setCachedProfile({ ...prev, ...payload })
      }
    }
  }

  wsClient.on('patch', handlePatch)
  
  return () => {
    wsClient.unsubscribe(userTopic)
    wsClient.unsubscribe(profileTopic)
    // cleanup handlers
  }
}, [user?.userId])
```

### 2. ProfileAdmin.tsx - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `tgUsername` –∏ `photoUrl`
- –û—Ç–ø—Ä–∞–≤–∫–∞ `PUT /api/users/:userId`
- –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ + WebSocket –ø–∞—Ç—á

**UI —ç–ª–µ–º–µ–Ω—Ç—ã:**
- –ö–Ω–æ–ø–∫–∞ "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å"
- –§–æ—Ä–º–∞ —Å –ø–æ–ª—è–º–∏ –≤–≤–æ–¥–∞
- –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ
- –ö–Ω–æ–ø–∫–∏ "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å" / "‚ùå –û—Ç–º–µ–Ω–∞"

## –ü—Ä–æ—Ç–æ–∫–æ–ª WebSocket –ø–∞—Ç—á–µ–π

### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
```json
{
  "type": "patch",
  "topic": "user:515650034",
  "payload": {
    "type": "profile_updated",
    "userId": "515650034",
    "tgUsername": "–ù–æ–≤–æ–µ –∏–º—è",
    "photoUrl": "https://–Ω–æ–≤–æ–µ-—Ñ–æ—Ç–æ.jpg",
    "updatedAt": "2025-10-01T17:30:00.000Z"
  }
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ `msg.type === 'patch'`
2. –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `topic` —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—á–∞ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é: `setUser(prev => ({ ...prev, ...payload }))`
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞: `setCachedProfile(updatedUser)`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ù–∞–∂–∞—Ç—å "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å"
3. –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è/—Ñ–æ—Ç–æ
4. –ù–∞–∂–∞—Ç—å "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–∏/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö
2. –í –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Ç–æ—Ä–∞—è –≤–∫–ª–∞–¥–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Telegram initData –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –∞–≤–∞—Ç–∞—Ä –≤ Telegram
2. –ó–∞—Ö–æ–¥–∏—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π initData)
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è real-time

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
- **Patch-based WebSocket:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π
- **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** ‚úÖ Cache + WebSocket —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- **Pub/Sub invalidation:** ‚úÖ Redis pub/sub + local cache clear

### üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```mermaid
sequenceDiagram
    participant U as User
    participant F1 as Frontend 1  
    participant F2 as Frontend 2
    participant B as Backend
    participant R as Redis
    participant DB as Database

    U->>F1: –ò–∑–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
    F1->>B: PUT /api/users/:userId
    B->>DB: UPDATE users
    B->>B: Invalidate cache
    B->>R: PUBLISH user:123 + profile
    R->>F1: WebSocket patch
    R->>F2: WebSocket patch
    F1->>F1: Apply patch to state
    F2->>F2: Apply patch to state
```

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–µ—Ç—Ä–∏–∫–∏:**
- **Retention:** üî¥ ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–ª—É—á—à–∞—é—Ç UX
- **Engagement:** üî¥ ‚Äî real-time –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–≤—ã—à–∞–µ—Ç –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å
- **Revenue:** ‚ö™ ‚Äî –∫–æ—Å–≤–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ —á–µ—Ä–µ–∑ –ª—É—á—à–∏–π UX
- **Tech Stability:** üî¥ ‚Äî WebSocket —Å–Ω–∏–∂–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ polling

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–¥–ø–∏—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è lazy (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ userId)
- Cleanup –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- Graceful degradation (WebSocket –æ—à–∏–±–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç auth flow)

## –ü—Ä–æ–≤–µ—Ä–∫–∏

- ‚úÖ Backend build: PASS
- ‚úÖ Frontend build: PASS  
- ‚úÖ TypeScript compilation: PASS
- ‚úÖ WebSocket –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ Cache invalidation —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Cleanup –ø–æ–¥–ø–∏—Å–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ WebSocket connections –∏ message rate
2. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É —Ç–æ–ø–∏–∫–æ–≤
3. **Persistence:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è offline –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. **Scaling:** Load balancing WebSocket connections –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
5. **Admin Dashboard:** –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ real-time –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã. –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–æ–ø–∏–∫–∏ `user:${userId}` 
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ `profile`
- –ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é –ø—Ä–∏ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ø—Ä–æ—Ñ–∏–ª—è
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—á–µ–π –≤ UI
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫—ç—à–∞ —Å WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –≤–∏–¥—è—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤ real-time –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.