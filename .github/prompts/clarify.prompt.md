description: Выявление недостаточно определенных областей в текущей спецификации функции путем задавания до 5 целевых уточняющих вопросов и внесения ответов обратно в спецификацию.
Пользовательский ввод может быть предоставлен напрямую агентом или как аргумент команды - вы ОБЯЗАНЫ учесть его перед продолжением (если не пустой).
Пользовательский ввод:
$ARGUMENTS
Цель: Обнаружить и устранить неоднозначности или отсутствующие точки принятия решений в активной спецификации функции и зафиксировать уточнения непосредственно в файле спецификации.
Примечание: Этот процесс уточнения должен выполняться (и завершаться) ДО вызова `/plan`. Если пользователь явно указывает, что пропускает уточнение (например, для экспериментального исследования), вы можете продолжить, но должны предупредить, что возрастает риск переделок на последующих этапах.
Этапы выполнения:
Запустите `.specify/scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly` из корня репозитория один раз. Распарсите минимальные поля JSON:
`FEATURE_DIR`
`FEATURE_SPEC`
(Опционально сохраните `IMPL_PLAN`, `TASKS` для будущих последовательных операций.)
Если парсинг JSON завершится неудачей, прервите выполнение и укажите пользователю повторно запустить `/specify` или проверить окружение рабочей ветки.
Загрузите текущий файл спецификации. Проведите структурированное сканирование на неоднозначность и полноту с использованием этой таксономии. Для каждой категории укажите статус: Четко / Частично / Отсутствует. Создайте внутреннюю карту покрытия для приоритизации (не выводите сырую карту, если вопросы задавать не нужно).
Функциональная область и поведение:
- Основные цели пользователя и критерии успеха
- Явные объявления того, что не входит в область
- Различия ролей/персонажей пользователя
Модель данных и домен:
- Сущности, атрибуты, отношения
- Правила идентификации и уникальности
- Жизненные циклы/состояния переходов
- Предположения о объеме и масштабе данных
Взаимодействие и UX-поток:
- Критические сценарии пользователя / последовательности
- Состояния ошибок/пустоты/загрузки
- Примечания по доступности или локализации
Качество нефункциональных характеристик:
- Производительность (задержки, целевые показатели пропускной способности)
- Масштабируемость (горизонтальная/вертикальная, ограничения)
- Надежность и доступность (время безотказной работы, ожидания восстановления)
- Наблюдаемость (логирование, метрики, трассировка)
- Безопасность и конфиденциальность (аутентификация/авторизация, защита данных, предположения об угрозах)
- Соответствие / регуляторные ограничения (при наличии)
Интеграция и внешние зависимости:
- Внешние сервисы/API и режимы сбоев
- Форматы импорта/экспорта данных
- Предположения о протоколе/версионировании
Краевые случаи и обработка сбоев:
- Негативные сценарии
- Ограничение скорости / регулирование
- Разрешение конфликтов (например, параллельные правки)
Ограничения и компромиссы:
- Технические ограничения (язык, хранилище, хостинг)
- Явные компромиссы или отклоненные альтернативы
Терминология и согласованность:
- Канонический глоссарий терминов
- Избегаемые синонимы / устаревшие термины
Сигналы завершения:
- Проверяемость критериев приемки
- Измеримые индикаторы определения "Готово"
Прочее / Заполнители:
- Метки TODO / нерешенные решения
- Неоднозначные прилагательные ("надежный", "интуитивный") без количественной оценки

Для каждой категории со статусом Частично или Отсутствует добавьте возможность вопроса для уточнения, если:
- Уточнение существенно не повлияет на реализацию или стратегию проверки
- Информация лучше отложить на этап планирования (отметьте внутренне)

Создайте (внутренне) приоритизированную очередь кандидатских вопросов для уточнения (максимум 5). НЕ выводите их все сразу. Примените эти ограничения:
- Максимум 5 вопросов за всю сессию.
- Каждый вопрос должен быть ответом в ОДНОМ из форматов:
  * Короткий выбор из нескольких вариантов (2-5 четких, взаимоисключающих вариантов), ИЛИ
  * Однословный / короткая фраза (явно ограничить: "Ответ не более 5 слов").
- Включайте только вопросы, ответы на которые существенно влияют на архитектуру, моделирование данных, декомпозицию задач, UX-поведение, операционную готовность или проверку соответствия.
- Обеспечьте баланс покрытия категорий: постарайтесь охватить наиболее важные нерешенные категории сначала; избегайте задавания двух маловажных вопросов, когда не решена одна важная область (например, безопасность).
- Исключите вопросы, на которые уже даны ответы, тривиальные предпочтения в стиле или детали выполнения на этапе планирования (если они не блокируют корректность).
- Отдавайте предпочтение уточнениям, которые снижают риск переделок или предотвращают несоответствия в критериях приемки.

Если осталось более 5 нерешенных категорий, выберите топ 5 по эвристике (Влияние * Неопределенность).

Последовательный цикл вопросов (интерактивный):
- Задавайте ТОЛЬКО ОДИН вопрос за раз.
- Для вопросов с несколькими вариантами ответа отобразите варианты в виде таблицы Markdown:
| Вариант | Описание |
| --- | --- |
| A | |
| B | |
| C | |
| Другой | Укажите другой короткий ответ (не более 5 слов) |
- Для вопросов с коротким ответом (без значимых дискретных вариантов) после вопроса выведите одну строку: `Формат: Короткий ответ (не более 5 слов)`.

После ответа пользователя:
- Проверьте, что ответ соответствует одному варианту или соответствует ограничению в 5 слов.
- Если ответ неоднозначен, запросите быстрое уточнение (счетчик остается для того же вопроса; не переходите к следующему).
- После получения удовлетворительного ответа запишите его в рабочую память (пока не записывайте на диск) и перейдите к следующему вопросу в очереди.

Прекратите задавать дополнительные вопросы, когда:
- Все критические неоднозначности разрешены (оставшиеся вопросы становятся ненужными), ИЛИ
- Пользователь сигнализирует о завершении ("готово", "хорошо", "больше не нужно"), ИЛИ
- Вы задали 5 вопросов.

Никогда не раскрывайте заранее будущие вопросы из очереди.

Если на старте нет допустимых вопросов, немедленно сообщите, что критических неоднозначностей нет.

Интеграция после КАЖДОГО принятого ответа (пошаговое обновление):
- Поддерживайте представление спецификации в памяти (загружено один раз в начале) вместе с содержимым исходного файла.
- Для первого интегрированного ответа в этой сессии:
  * Убедитесь, что существует раздел `## Уточнения` (создайте его сразу после самого высокого контекстного/обзорного раздела в соответствии с шаблоном спецификации, если отсутствует).
  * В нем создайте (если отсутствует) подзаголовок `### Сессия ГГГГ-ММ-ДД` на сегодняшнюю дату.
  * Добавьте пункт сразу после принятия: `- В: <вопрос> → О: <окончательный ответ>`.
  * Затем немедленно примените уточнение к наиболее подходящему разделу(ам):
    - Функциональная неоднозначность → Обновите или добавьте пункт в раздел Функциональные Требования.
    - Взаимодействие с пользователем / различие акторов → Обновите раздел Пользовательские Истории или Акторы (если присутствует) с уточненной ролью, ограничением или сценарием.
    - Форма данных / сущности → Обновите Модель Данных (добавьте поля, типы, отношения), сохраняя порядок; кратко укажите добавленные ограничения.
    - Ограничение нефункциональной характеристики → Добавьте/измените измеримые критерии в разделе Нефункциональные Требования / Качественные Атрибуты (преобразуйте расплывчатое прилагательное в метрику или явную цель).
    - Краевой случай / негативный поток → Добавьте новый пункт в раздел Краевые Случаи / Обработка Ошибок (или создайте такой подраздел, если шаблон предоставляет для этого место).
    - Конфликт терминологии → Нормализуйте термин по всей спецификации; сохраните оригинальный термин только если необходимо, добавив `(ранее упоминалось как "X")` один раз.
    - Если уточнение делает устаревшим ранее неоднозначное утверждение, замените это утверждение вместо дублирования; не оставляйте противоречивый устаревший текст.

- Сохраните файл спецификации ПОСЛЕ КАЖДОЙ интеграции, чтобы минимизировать риск потери контекста (атомическая перезапись).
- Сохраняйте форматирование: не меняйте порядок несвязанных разделов; сохраняйте иерархию заголовков.
- Делайте каждое вставленное уточнение минимальным и проверяемым (избегайте нарративных отклонений).

Проверка (выполняется ПОСЛЕ КАЖДОЙ записи плюс финальная проверка):
- Сессия уточнений содержит ровно один пункт на каждый принятый ответ (без дубликатов).
- Общее количество заданных (принятых) вопросов ≤ 5.
- Обновленные разделы не содержат оставшихся расплывчатых заполнителей, которые должен был разрешить новый ответ.
- Нет противоречивых более ранних утверждений (проверьте наличие теперь недействительных альтернативных вариантов).
- Структура Markdown валидна; разрешены только новые заголовки: `## Уточнения`, `### Сессия ГГГГ-ММ-ДД`.
- Согласованность терминологии: один и тот же канонический термин используется во всех обновленных разделах.

Запишите обновленную спецификацию обратно в `FEATURE_SPEC`.

Сообщите о завершении (после окончания цикла вопросов или раннего завершения):
- Количество заданных и полученных ответов.
- Путь к обновленной спецификации.
- Затронутые разделы (перечислите названия).
- Сводная таблица покрытия, перечисляющая каждую категорию таксономии со статусом: Решено (было Частично/Отсутствует и решено), Отложено (превышен лимит вопросов или лучше подходит для этапа планирования), Четко (уже достаточно), Осталось (все еще Частично/Отсутствует, но низкое влияние).
- Если остались Категории в статусе Осталось или Отложено, рекомендуйте продолжить к `/plan` или повторно запустить `/clarify` позже после планирования.
- Предложите следующую команду.

Правила поведения:
- Если не обнаружено значимых неоднозначностей (или все потенциальные вопросы будут маловажными), ответьте: "Не обнаружено критических неоднозначностей, требующих формального уточнения." и предложите продолжить.
- Если файл спецификации отсутствует, укажите пользователю сначала запустить `/specify` (не создавайте новую спецификацию здесь).
- Никогда не превышайте 5 общих заданных вопросов (повторные уточнения для одного вопроса не считаются новыми вопросами).
- Избегайте спекулятивных вопросов о технологическом стеке, если их отсутствие не блокирует функциональную ясность.
- Уважайте сигналы пользователя о раннем завершении ("стоп", "готово", "продолжить").
- Если вопросы не задавались из-за полного покрытия, выведите компактную сводку покрытия (все категории Четко), затем предложите перейти к следующему этапу.
- Если достигнут лимит вопросов с оставшимися высоковажными категориями, явно пометьте их как Отложенные с обоснованием.

Контекст для приоритизации: $ARGUMENTS