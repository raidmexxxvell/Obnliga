# –ü—É–±–ª–∏—á–Ω—ã–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏ WebSocket-—Ç–æ–ø–∏–∫–∏

–î–∞—Ç–∞: 2025-10-05
–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: GitHub Copilot (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç)

## 1. –¶–µ–ª–∏
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É–±–ª–∏—á–Ω–æ–π –≤–∏—Ç—Ä–∏–Ω–µ (–ø–æ—Ä—Ç–∞–ª—É –∏ Telegram WebApp) –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
- –û–±–µ—Å–ø–µ—á–∏—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É HTTP-–æ—Ç–≤–µ—Ç–∞–º–∏ –∏ WebSocket-–ø–∞—Ç—á–∞–º–∏.
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ Postgres —á–µ—Ä–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ multilevel cache + –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.
- –û–±–æ–π—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Render.com –Ω–∞ –ø–ª–∞—Ç–Ω—ã–µ background worker'—ã: –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–∏—Å–∞.

## 2. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö (reuse)
| –ú–æ–¥—É–ª—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
| --- | --- | --- |
| `backend/src/services/matchAggregation.ts` | —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ç—á–µ–π, –ø–µ—Ä–µ—Å—á—ë—Ç —Å–µ–∑–æ–Ω–Ω—ã—Ö/–∫–∞—Ä—å–µ—Ä–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ | –û—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—É–±–ª–∏—á–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤.
| `backend/src/routes/adminRoutes.ts` | –≥–æ—Ç–æ–≤—ã–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–±–æ—Ä–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ | –ë—ç–∫—ç–Ω–¥-–ª–æ–≥–∏–∫–∞/SQL –∑–∞–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö API.
| `defaultCache` (multilevel) | Redis + LRU + –≤–µ—Ä—Å–∏–∏ | –®–∞—Ä–∏–º –∫–ª—é—á–∏, –¥–æ–±–∞–≤–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ —Å –Ω–æ–≤—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `public:`.
| `admin/src/store/adminStore.ts` TTL-—ã | –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –æ—Ä–∏–µ–Ω—Ç–∏—Ä –¥–ª—è SWR –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ.

## 3. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ HTTP —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (GET)
| –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö | –ö—ç—à-–∫–ª—é—á | TTL | ETag/–í–µ—Ä—Å–∏—è |
| --- | --- | --- | --- | --- | --- |
| `/api/public/league/table` | —Ç—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ–∑–æ–Ω–∞ | `getSeasonClubStats` (reuse) | `public:league:table` | 15 c | `ETag` + `X-Resource-Version`
| `/api/public/league/top-scorers` | —Ç–æ–ø –±–æ–º–±–∞—Ä–¥–∏—Ä–æ–≤ (—Ç–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω) | `getSeasonPlayerStats` | `public:league:top-scorers` | 30 c | –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
| `/api/public/league/form` | —Å–µ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∫–ª—É–±–∞–º | –Ω–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ (–Ω–∞ –±–∞–∑–µ `matchAggregation`) | `public:league:form:{seasonId}` | 60 c | –¥–∞
| `/api/public/matches/live` | —Å–ø–∏—Å–æ–∫ live-–º–∞—Ç—á–µ–π —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ | reuse `match` —Ç–∞–±–ª–∏—Ü—ã (—Å—Ç–∞—Ç—É—Å LIVE) | `public:matches:live` | 5 c | –¥–∞
| `/api/public/club/:clubId/summary` | –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∫–ª—É–±–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∞—Ç—á–µ–π, —Ç–æ–ø –∏–≥—Ä–æ–∫–∏) | –∫–æ–º–±–∏–Ω–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ + `playerCareerStats` | `public:club:{clubId}:summary` | 120 c | –¥–∞
| `/api/public/predictions/leaderboard` | –æ–±—â–∏–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ | reuse admin predictions –∞–≥—Ä–µ–≥–∞—Ç–∞ | `public:predictions:leaderboard` | 120 c | –¥–∞

### –û—Ç–≤–µ—Ç—ã
- –°—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `shared/types.ts` (–ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã `PublicLeagueTableRow`, `PublicScorer`, `ClubSummary` –∏ —Ç.–¥.).
- –í—Å–µ –æ—Ç–≤–µ—Ç—ã ‚Äî `Envelope { ok, data, meta: { version, ttl } }`.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º `If-None-Match` —Å existing `etag` –ø–ª–∞–≥–∏–Ω–æ–º + –≤–µ—Ä—Å–∏—é –∏–∑ multilevel cache.

## 4. WebSocket-—Ç–æ–ø–∏–∫–∏
| –¢–æ–ø–∏–∫ | –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | –¢—Ä–∏–≥–≥–µ—Ä—ã | Payload |
| --- | --- | --- | --- |
| `league:table` | `patch`/`full` | `match_finalized`, —Ä—É—á–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è | –º–∞—Å—Å–∏–≤ standings + `version`
| `league:scorers` | `patch` | –≥–æ–ª/—É–¥–∞–ª–µ–Ω–∏–µ | —Ç–æ–ø-—Å–ø–∏—Å–æ–∫, —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç, —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π payload
| `matches:live` | `patch` | –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Ç—á–∞ (—Å—á—ë—Ç/—Å—Ç–∞—Ç—É—Å) | —Å–ø–∏—Å–æ–∫ live-–º–∞—Ç—á–µ–π + version
| `club:{clubId}:summary` | `full` | –º–∞—Ç—á–∏ –∫–ª—É–±–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã/–∏–∑–º–µ–Ω–µ–Ω—ã | –æ–±—ä–µ–∫—Ç summary + version
| `predictions:leaderboard` | `full` | –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∞—Ç—á–µ–π, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–æ–∫ | —Ç–æ–ø-–ª–∏—Å—Ç + version

**–ü—Ä–æ—Ç–æ–∫–æ–ª:**
```json
{
  "protocolVersion": 1,
  "type": "patch" | "full",
  "topic": "league:table",
  "version": 42,
  "payload": { ...diff –∏–ª–∏ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ }
}
```
- –î–ª—è —Ç–∞–±–ª–∏—Ü—ã –∏ —Ç–æ–ø –±–æ–º–±–∞—Ä–¥–∏—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º `jsondiffpatch` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ç—á–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, MVP ‚Äî full-update).
- –ö–ª–∏–µ–Ω—Ç –æ–±—è–∑–∞–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å `version`; –µ—Å–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω –ø–∞—Ç—á, –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å HTTP.

## 5. –í–æ—Ä–∫–µ—Ä—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Redis
### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Render.com
- –ù–µ–ª—å–∑—è –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π Background Worker –±–µ–∑ –¥–æ–ø–ª–∞—Ç—ã.
- –†–µ—à–µ–Ω–∏–µ: –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º BullMQ Worker –≤–Ω—É—Ç—Ä—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Fastify-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (in-process worker).

### –ü–æ–¥—Ö–æ–¥
1. –°–æ–∑–¥–∞—ë–º –æ—á–µ—Ä–µ–¥—å `stats-aggregation` (BullMQ).
2. –ù–∞ `server.ready` —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º `Worker` —Å `concurrency = 1`, `autorun = false` –≤ dev; –≤ –ø—Ä–æ–¥ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∑–∞–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ `ENABLE_INPROC_WORKER=true`.
3. –¢—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á:
   - `handleMatchFinalization` –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ ‚Üí `queue.add('rebuild-public-aggregates', { seasonId, competitionId, clubIds }, { jobId: ... , removeOnComplete: true })`.
   - Cron-like –∑–∞–¥–∞—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —á–µ—Ä–µ–∑ `QueueScheduler`/`repeatable` jobs, –Ω–æ –≤ MVP –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å—Å—è —Å–æ–±—ã—Ç–∏—è–º–∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏.
4. –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –∑–∞–¥–∞—á–∏:
   - –°—Ç—Ä–æ–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ `adminRoutes`);
   - –û–±–Ω–æ–≤–ª—è–µ—Ç Redis –∫–ª—é—á–∏ (`defaultCache.set`) –∏ –ø—É–±–ª–∏–∫—É–µ—Ç `server.publishTopic` –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–ø–∏–∫–æ–≤.
5. –§–æ–ª–±—ç–∫ –ø—Ä–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–º worker: HTTP —Ö—ç–Ω–¥–ª–µ—Ä—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç lazy-loading (–∫–∞–∫ —Å–µ–π—á–∞—Å), –≤–µ—Ä—Å–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ invalidate.

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –õ–∏–º–∏—Ç–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ job'–æ–≤ (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ `jobId` = `${seasonId}:${type}` ).
- –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ (count hits/misses) –ø–æ–∑–∂–µ.
- –ë—É–ª–ª-–∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—É –∂–µ Redis-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.

## 6. TTL –∏ –∫—ç—à-–∫–ª—é—á–∏
- –ü—Ä–µ—Ñ–∏–∫—Å `public:` –¥–ª—è –æ—Ç–¥–µ–ª–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∫—ç—à–µ–π.
- –ü—Ä–∏–º–µ—Ä—ã: `public:league:table`, `public:league:top-scorers`, `public:club:${clubId}:summary`.
- TTL —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω —Å UX: —Ç–∞–±–ª–∏—Ü–∞ ‚Äî 15 c (üî¥), live-–º–∞—Ç—á–∏ ‚Äî 5 c (üî¥), —Ç–æ–ø-—Å—á—ë—Ç—á–∏–∫–∏ ‚Äî 30 c (üîµ), –∫–ª—É–±–Ω–∞—è —Å–≤–æ–¥–∫–∞ ‚Äî 120 c (‚ö™), –ª–∏–¥–µ—Ä–±–æ—Ä–¥ ‚Äî 120 c (üîµ).
- –í–µ—Ä—Å–∏–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è –≤ –≤–æ—Ä–∫–µ—Ä–µ, –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `X-Resource-Version`.

## 7. –ü–ª–∞–Ω —Ä–∞–±–æ—Ç
1. **(–¢–µ–∫—É—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç)** –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ö–µ–º—ã HTTP/WS –∏ –≤–æ—Ä–∫–µ—Ä–∞ ‚Äî ‚úÖ.
2. –î–æ–±–∞–≤–∏—Ç—å shared —Ç–∏–ø—ã –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤, —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `/api/public/*` –º–∞—Ä—à—Ä—É—Ç—ã —Å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏.
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å BullMQ Worker –≤ `backend/src/server.ts` (hook `onReady`).
4. –†–∞—Å—à–∏—Ä–∏—Ç—å `matchAggregation` –¥–ª—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ job'–æ–≤ –≤ –æ—á–µ—Ä–µ–¥—å + –ø—É–±–ª–∏–∫–∞—Ü–∏—è WS.
5. –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ WS (`frontend/src/wsClient.ts`) —Å –ø–æ–¥–ø–∏—Å–∫–æ–π –Ω–∞ –Ω–æ–≤—ã–µ —Ç–æ–ø–∏–∫–∏.
6. –ü–æ–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (`docs/api-contracts.md`, `docs/cache.md`, `docs/state.md`) –∏ —Ç–µ—Å—Ç—ã.

## 8. –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã / TODO
- –£—Ç–æ—á–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–ª—è `league/form` (–Ω—É–∂–Ω—ã –ª–∏ streaks –∏–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥?).
- –†–µ—à–∏—Ç—å, –Ω—É–∂–µ–Ω –ª–∏ –æ–±—â–∏–π endpoint –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∑–æ–Ω–æ–≤ (–∏—Å—Ç–æ—Ä–∏—è).
- –î–æ–ø–æ–ª–Ω–∏—Ç—å roadmap –∑–∞–¥–∞—á–∞–º–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É worker (BullBoard/Sentry breadcrumbs).
- –ü–æ—Å–ª–µ MVP ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ patch-–¥–∏—Ñ—Ñ—ã –¥–ª—è `league:table`.
