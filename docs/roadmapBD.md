# Roadmap BD — Админ управление лиги

Дата: 2025-10-01

## 1. Базовая модель данных
- **Club**: обязательные поля (name, short_name, logo_url). Ограничение на удаление, если клуб участвует в активном сезоне или фигурирует в завершённом матче (нужен soft-delete/архив).
- **Person**: общий справочник для игроков и судей (флаг `is_player`). Запрет удаления, если есть участие в заявке или составе матча.
- **Stadium**: справочник площадок; удаление запрещено при ссылках из матчей.
- **Competition**: литеры турниров, новое поле `series_format`:`'SINGLE_MATCH'|'TWO_LEGGED'|'BEST_OF_N'`.

## 2. Конфигурация сезонов
1. Создать сезон `Season` с датами и ссылкой на `Competition`.
2. Назначить участников через `Season_Participant` (клубы). Удаление участника запрещено, если клуб уже сыграл матч.
3. Сформировать заявки (`Season_Roster`): валидация `is_player`, уникальный `shirt_number` в рамках клуба/сезона.

## 3. Расписание и серии
- **Match_Series** (плей-офф): обязательные поля `stage_name`, `home_club_id`, `away_club_id`, `series_status`, `winner_club_id` (NULL до завершения).
- **Match**: поддержка лиги и плей-офф (`series_id`, `series_match_number`), статусы (`SCHEDULED|LIVE|FINISHED|POSTPONED`), привязка к стадиону и судье.
- Бизнес-правило: при завершении матча (status → `FINISHED`) запускается агрегатор:
  - Пересчёт счёта серии и обновление `Match_Series` (при необходимости ставит `winner_club_id`).
  - Триггеры статистики и дисквалификаций.

## 4. Детали матча
- **Match_Lineup**: состав матча с ролями (`STARTER|SUBSTITUTE`). Перед сохранением проверять `Disqualification.is_active`.
- **Match_Event**: события типа `GOAL|YELLOW_CARD|RED_CARD|SUB_IN|SUB_OUT`. Для голов и карточек запускать пересчёт агрегатов, при красной карточке создавать `Disqualification`.

## 5. Агрегированная статистика
- **Player_Season_Stats**: обновлять сразу после матча (голы, ассисты, карточки).
- **Player_Club_Career_Stats**: пополнять в конце сезона суммарными значениями из сезонной статистики.
- **Club_Season_Stats**: очки, победы/поражения, разница мячей — самое востребованное для отчетности.
- Никаких прямых правок из админки: отображение read-only, изменения делаются через первичные сущности.

## 6. Пользователи и прогнозы
- **App_User**: хранить `last_login_date`, `current_streak`, `total_predictions`. Логика входа должна обновлять streak и триггерить проверку достижений.
- **Prediction**: записи прогнозов с результатами. После каждого завершённого матча пересчитывать `is_correct` и начислять `points_awarded`.
- **Achievement_Type / User_Achievement**: CRUD по типам достижений (редактирование требует массового пересчёта) и просмотр/отзыв выданных достижений.

## 7. Дисквалификации
- **Disqualification**: автоматическое создание (красная карточка, лимит жёлтых) + ручное управление (причина `OTHER`). После каждого завершённого матча увеличивать `matches_missed`, отключать бан при достижении лимита.

## 8. Админ-дэшборд
- Вкладки и основная функциональность:
  1. **Справочники**: Club / Person / Stadium / Achievement_Type.
  2. **Сезоны**: управление Season, Season_Participant, Season_Roster.
  3. **Матчи и серии**: Match_Series, Match, Match_Lineup, Match_Event, автоматический пересчёт.
  4. **Статистика**: read-only представления статистических таблиц, фильтры по сезону/клубу/игроку.
  5. **Пользователи и прогнозы**: просмотр App_User, Prediction, User_Achievement, корректировки streak и очков.
  6. **Дисквалификации**: лист активных банов, ручные правки.
- Каждое действие запускает обновление кэша (мульти-уровень) и уведомление WS для фронтенда.

## 9. Триггеры и фоновые задачи
- После `Match.status=FINISHED`: агрегировать статистику, обновить дисквалификации, проверить достижения, пересчитать корректность прогнозов.
- Ночной/периодический джоб: перенос сезонных данных в карьерную статистику, закрытие устаревших дисквалификаций.
- Проверка streak: при каждом log-in.

## 10. Приоритеты реализации
1. Обновить Prisma schema и миграции под перечисленные таблицы и связи.
2. Реализовать backend API (Fastify + Prisma) с валидацией и сервисными слоями.
3. Доработать admin SPA: формы, таблицы, валидации, автоматические обновления.
4. Интегрировать multilevel cache/WS-инвалидацию и логирование admin действий.
5. Покрытие тестами (unit + интеграционные) и документация процессов.
